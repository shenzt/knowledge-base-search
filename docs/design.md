# knowledge-base-search â€” è®¾è®¡æ–‡æ¡£

> ç‰ˆæœ¬: v1.0 | æ—¥æœŸ: 2025-02
> çŠ¶æ€: æ ¸å¿ƒåŠŸèƒ½å·²éªŒè¯ï¼Œè¯„æµ‹ä½“ç³»å·²å»ºç«‹
> éƒ¨ç½²æ¨¡å¼: çº¯æœ¬åœ°

---

## 1. æ ¸å¿ƒç†å¿µ

**Claude Code å°±æ˜¯ agentã€‚** èƒ½ç”¨ agent åšçš„äº‹æƒ…å°±è®©å®ƒåšï¼Œä¸å†™å¤šä½™ä»£ç ã€‚

è¿™æ˜¯ä¸€å¥— Agentic RAG çš„æœ¬åœ°åŒ–è½åœ°æ–¹æ¡ˆï¼š
- Git ä»“åº“ä½œä¸ºæ–‡æ¡£å•ä¸€äº‹å®žæºï¼ˆSSOTï¼‰ï¼šç‰ˆæœ¬åŒ–ã€å¯è¿½æº¯ã€å¯å›žæ»š
- Claude Code ä½œä¸ºæ ¸å¿ƒ agentï¼šæ–‡æ¡£å¯¼å…¥ã€æ£€ç´¢ã€å®¡æŸ¥å…¨éƒ¨é€šè¿‡ Skills ç¼–æŽ’
- Qdrant ä½œä¸ºå¯å†ç”Ÿç´¢å¼•å±‚ï¼šæœ¬åœ°æ··åˆæ£€ç´¢ï¼Œä¸­è‹±æ–‡å‡æœ‰ä¸€æµæ”¯æŒ
- MCP Server åªåšä¸€ä»¶äº‹ï¼šå‘é‡æ£€ç´¢ï¼ˆå› ä¸ºéœ€è¦å¸¸é©» BGE-M3 æ¨¡åž‹ï¼‰

### è®¾è®¡åŽŸåˆ™

1. **æžç®€ä»£ç ** â€” åªå†™ agent åšä¸äº†çš„ï¼ˆå‘é‡ç¼–ç /æ£€ç´¢éœ€è¦å¸¸é©»æ¨¡åž‹ï¼‰
2. **Skills å®šä¹‰è¡Œä¸º** â€” Claude Code ç”¨å†…ç½®å·¥å…·ï¼ˆRead/Grep/Glob/Bash/Writeï¼‰æ‰§è¡Œ
3. **Git ç®¡ç†ä¸€åˆ‡** â€” æ–‡æ¡£ã€é…ç½®ã€Skills å…¨éƒ¨ç‰ˆæœ¬åŒ–ï¼Œç´¢å¼•å¯å†ç”Ÿä¸è¿› Git
4. **ä¸­è‹±æ–‡å¹¶é‡** â€” BGE-M3 å¤©ç„¶æ”¯æŒå¤šè¯­è¨€ï¼ŒåŒ…æ‹¬è·¨è¯­è¨€æ£€ç´¢

### æž¶æž„åˆ†å±‚è§„èŒƒ

| å±‚ | è§’è‰² | åˆ¤æ–­æ ‡å‡† |
|---|---|---|
| Skill (SKILL.md) | å·¥ä½œæµç¼–æŽ’ | æ¯æ­¥éƒ½èƒ½ç”¨ Claude Code å†…ç½®å·¥å…·å®Œæˆ |
| Python è„šæœ¬ | ç¡®å®šæ€§é‡æ´» | éœ€è¦å¸¸é©»æ¨¡åž‹ã€å‘é‡è®¡ç®—ã€æŒä¹…è¿žæŽ¥ |
| Subagent | éš”ç¦»çš„æ™ºèƒ½ä»»åŠ¡ | éœ€è¦ LLM åšå†³ç­– + éš”ç¦» context |

è¯¦è§ `.claude/rules/agent-architecture.md`ã€‚

---

## 2. æŠ€æœ¯é€‰åž‹

### å‘é‡æ•°æ®åº“ï¼šQdrant

åŽŸç”Ÿ dense + sparse æ··åˆæ£€ç´¢ + RRF èžåˆï¼Œmultilingual å…¨æ–‡ç´¢å¼•ï¼ˆcharabia/jiebaï¼‰ï¼Œç”Ÿäº§çº§æˆç†Ÿåº¦ã€‚Docker ä¸€é”®å¯åŠ¨ã€‚

### Embeddingï¼šBAAI/bge-m3

8K ä¸Šä¸‹æ–‡ã€å•æ¨¡åž‹è¾“å‡º denseï¼ˆ1024dï¼‰+ sparseï¼ˆlearned lexical weightsï¼‰+ ColBERTã€‚sparse å‘é‡æ›¿ä»£ä¼ ç»Ÿ jieba + BM25ï¼Œæ— éœ€é¢å¤–åˆ†è¯ç®¡çº¿ã€‚C-MTEB ~62-63ã€‚

### Rerankerï¼šBAAI/bge-reranker-v2-m3

åŒç³»åˆ—ï¼Œä¸­è‹±æ–‡ rerank æ•ˆæžœå¥½ã€‚

### æ–‡æ¡£é¢„å¤„ç†

ä¸å†…ç½®é¢„å¤„ç†ä»£ç ã€‚Claude Code é€šè¿‡ Bash è°ƒç”¨æœ¬åœ°å·²å®‰è£…çš„ CLI å·¥å…·ï¼š

| åœºæ™¯ | æŽ¨èå·¥å…· | å®‰è£…æ–¹å¼ |
|------|---------|---------|
| ä¸­æ–‡ PDF | MinerU | `pip install magic-pdf` |
| é€šç”¨æ–‡æ¡£ | Docling / Marker | `pip install docling` / `pip install marker-pdf` |
| ç½‘é¡µ | curl + pandoc | ç³»ç»Ÿè‡ªå¸¦ |
| DOCX/PPTX | pandoc | `apt install pandoc` |

---

## 3. ç³»ç»Ÿæž¶æž„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç”¨æˆ· / Claude Code IDE               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â–¼            â–¼            â–¼          â–¼
  /search      /ingest     /index-docs  /review
      â”‚            â”‚            â”‚          â”‚
      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚          â”‚
      â”‚  â”‚  Claude Code å†…ç½®å·¥å…·              â”‚
      â”‚  â”‚  Read/Grep/Glob/Bash/Write       â”‚
      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚          â”‚
      â–¼            â–¼            â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  knowledge-base MCP Serverï¼ˆå”¯ä¸€çš„è‡ªå»ºä»£ç ï¼‰    â”‚
â”‚  - hybrid_search (dense+sparse+RRF+rerank)   â”‚
â”‚  - keyword_search (full-text fallback)       â”‚
â”‚  - index_status                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
     â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Qdrant  â”‚ â”‚  Git çŸ¥è¯†åº“ä»“åº“        â”‚
â”‚  (æœ¬åœ°)   â”‚ â”‚  docs/ â† Markdown    â”‚
â”‚          â”‚ â”‚  raw/  â† åŽŸå§‹æ–‡ä»¶     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ£€ç´¢ç­–ç•¥ï¼ˆä¸¤å±‚ï¼‰

| å±‚ | æ–¹å¼ | é€‚ç”¨åœºæ™¯ | æˆæœ¬ |
|----|------|---------|------|
| ç¬¬ä¸€å±‚ | Grep/Globï¼ˆClaude Code å†…ç½®ï¼‰ | å…³é”®è¯æ˜Žç¡®ã€æœ¯è¯­ã€é”™è¯¯ç  | é›¶ï¼ˆæ— éœ€æ¨¡åž‹ï¼‰ |
| ç¬¬äºŒå±‚ | MCP hybrid_search | è¯­ä¹‰/æ¨¡ç³Š/è·¨è¯­è¨€æŸ¥è¯¢ | éœ€è¦ BGE-M3 æ¨¡åž‹ |

é€‰æ‹©é€»è¾‘ï¼šå…³é”®è¯æ˜Žç¡® â†’ å…ˆç¬¬ä¸€å±‚ï¼›æ¨¡ç³Š/æ¦‚å¿µæ€§ â†’ ç›´æŽ¥ç¬¬äºŒå±‚ï¼›ç¬¬ä¸€å±‚ä¸å¤Ÿ â†’ è¡¥å……ç¬¬äºŒå±‚ã€‚

---

## 4. Skills è®¾è®¡

### /search â€” çŸ¥è¯†åº“æ£€ç´¢

Agent è‡ªä¸»è·¯ç”±ï¼šGrepï¼ˆç²¾ç¡®å…³é”®è¯ï¼‰/ hybrid_searchï¼ˆè¯­ä¹‰æ¨¡ç³Šï¼‰/ Readï¼ˆå®Œæ•´ä¸Šä¸‹æ–‡ï¼‰ã€‚å¯å¹¶è¡Œè°ƒç”¨ã€‚å›žç­”å¿…é¡»å¸¦å¼•ç”¨ `[æ¥æº: docs/xxx.md > section_path]`ã€‚

### /ingest â€” å•æ–‡æ¡£å¯¼å…¥

Claude Code åˆ¤æ–­è¾“å…¥ç±»åž‹ â†’ è°ƒ CLI è½¬æ¢ â†’ æ•´ç† Markdown + front-matter â†’ ä¿å­˜åˆ° docs/ â†’ git commit â†’ ç´¢å¼•ã€‚

### /ingest-repo â€” Git ä»“åº“å¯¼å…¥

æ ¸å¿ƒèƒ½åŠ›ã€‚å°†ä»»æ„ Git ä»“åº“çš„ Markdown æ–‡æ¡£å¯¼å…¥çŸ¥è¯†åº“ï¼š
1. Shallow clone ä»“åº“åˆ°ä¸´æ—¶ç›®å½•
2. æ‰«æ .md æ–‡ä»¶ï¼ˆæ ¼å¼è·¯ç”±é¢„ç•™ PDF/DOCX/HTML æ¡©ï¼‰
3. æ³¨å…¥æº¯æº front-matterï¼ˆsource_repo, source_path, source_commitï¼‰
4. è¾“å‡ºåˆ°å¤–éƒ¨ç‹¬ç«‹ Git ç›®å½•ï¼ˆ`--target-dir`ï¼‰ï¼Œä¿ç•™åŽŸå§‹ç›®å½•ç»“æž„
5. Drop æ—§ç´¢å¼• + å…¨é‡é‡å»ºï¼ˆæŒ‰ source_repo è¿‡æ»¤åˆ é™¤ï¼‰
6. åœ¨å¤–éƒ¨ç›®å½• git commit ä¿ç•™åŽ†å²ç‰ˆæœ¬

è®¾è®¡è¦ç‚¹ï¼š
- å­˜å‚¨éš”ç¦»ï¼šç”Ÿæˆçš„æ–‡æ¡£ä¸æ”¾åœ¨ä»£ç ä»“åº“ä¸­ï¼Œè¾“å‡ºåˆ°å¤–éƒ¨ Git ç›®å½•
- æº¯æºå®Œæ•´ï¼šæ¯ä¸ª chunk çš„ Qdrant payload åŒ…å« source_repo/source_path/source_commit
- æ¯æ¬¡é‡å»ºï¼šåˆæœŸ repo ä¸å¤§ï¼Œdrop + full rebuild ä¿è¯ä¸€è‡´æ€§
- æ ¼å¼æ‰©å±•ï¼šæœªæ¥ PDF ç”¨ MinerUï¼Œå¯èƒ½éœ€è¦ Subagent åšæ™ºèƒ½æ¸…æ´—

### /index-docs â€” ç´¢å¼•ç®¡ç†

çº¯ Bash è°ƒç”¨ index.pyï¼Œæ”¯æŒ --status / --file / --full / --incremental / --delete-by-repoã€‚

### /review â€” æ–‡æ¡£å®¡æŸ¥

Claude Code ç”¨ Read/Grep/Glob ç›´æŽ¥æ£€æŸ¥ front-matter å®Œæ•´æ€§ã€æ—¶æ•ˆæ€§ã€TODO æ ‡è®°ç­‰ï¼Œè¾“å‡ºå¥åº·åº¦è¯„åˆ†ã€‚

### /eval â€” RAG è¯„æµ‹

64 ä¸ªç”¨ä¾‹ï¼ˆLocal 17 + Qdrant 41 + Notfound 6ï¼‰ï¼Œä¸¤é˜¶æ®µè¯„ä¼°ï¼šGate é—¨ç¦ï¼ˆç¡®å®šæ€§è§„åˆ™ï¼‰â†’ è´¨é‡æ£€æŸ¥ã€‚

---

## 5. æ–‡æ¡£è§„èŒƒ

### Front-matterï¼ˆå¿…é¡»ï¼‰

```yaml
---
id: "d7f3a2b1"           # ç¨³å®šä¸»é”®ï¼Œé¦–æ¬¡åˆ›å»ºæ—¶ç”Ÿæˆï¼Œä¸å¯ä¿®æ”¹
title: "æ–‡æ¡£æ ‡é¢˜"
owner: "@è´Ÿè´£äºº"
tags: [åˆ†ç±»æ ‡ç­¾]
created: YYYY-MM-DD
last_reviewed: YYYY-MM-DD
confidence: high | medium | low | deprecated
---
```

- `id` æ˜¯ Qdrant ç´¢å¼•çš„ç¨³å®šä¸»é”®ï¼Œé‡å‘½å/ç§»åŠ¨æ–‡ä»¶æ—¶ä¸å˜
- æ–°å¯¼å…¥æ–‡æ¡£é»˜è®¤ `confidence: medium`
- `last_reviewed` è¶…è¿‡ 6 ä¸ªæœˆåº”æé†’æ›´æ–°

### ç›®å½•ç»“æž„

```
docs/
â”œâ”€â”€ runbook/          # è¿ç»´æ‰‹å†Œ
â”œâ”€â”€ adr/              # æž¶æž„å†³ç­–è®°å½•
â”œâ”€â”€ api/              # API æ–‡æ¡£
â”œâ”€â”€ postmortem/       # äº‹åŽå¤ç›˜
â””â”€â”€ meeting-notes/    # ä¼šè®®çºªè¦
```

---

## 6. é¡¹ç›®ç»“æž„

```
knowledge-base-search/
â”œâ”€â”€ CLAUDE.md                    # Agent ä¸Šä¸‹æ–‡
â”œâ”€â”€ .mcp.json                    # MCP Server é…ç½®
â”œâ”€â”€ Makefile                     # å¿«æ·å‘½ä»¤
â”œâ”€â”€ docker-compose.yml           # Qdrant
â”œâ”€â”€ .claude/
â”‚   â”œâ”€â”€ rules/                   # çº¦æŸè§„åˆ™
â”‚   â”‚   â”œâ”€â”€ agent-architecture.md  # Skill vs Python vs Subagent è§„èŒƒ
â”‚   â”‚   â”œâ”€â”€ retrieval-strategy.md
â”‚   â”‚   â”œâ”€â”€ doc-frontmatter.md
â”‚   â”‚   â”œâ”€â”€ python-style.md
â”‚   â”‚   â””â”€â”€ testing-lessons.md
â”‚   â””â”€â”€ skills/                  # Agent æŠ€èƒ½
â”‚       â”œâ”€â”€ search/SKILL.md
â”‚       â”œâ”€â”€ ingest/SKILL.md
â”‚       â”œâ”€â”€ ingest-repo/SKILL.md
â”‚       â”œâ”€â”€ index-docs/SKILL.md
â”‚       â”œâ”€â”€ review/SKILL.md
â”‚       â””â”€â”€ eval/SKILL.md
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ mcp_server.py            # å‘é‡æ£€ç´¢ MCP Server
â”‚   â”œâ”€â”€ index.py                 # ç´¢å¼•æž„å»ºå·¥å…·ï¼ˆheading-based chunking + section_pathï¼‰
â”‚   â”œâ”€â”€ eval_module.py           # è¯„ä¼°æ¨¡å—ï¼ˆextract_contexts + gate_checkï¼‰
â”‚   â””â”€â”€ requirements.txt
â”œâ”€â”€ docs/                        # çŸ¥è¯†åº“æ–‡æ¡£ï¼ˆGit ç®¡ç†ï¼‰
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/                    # å•å…ƒæµ‹è¯• (40 tests)
â”‚   â”œâ”€â”€ integration/             # é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ e2e/                     # E2E æµ‹è¯• (Agent SDK)
â””â”€â”€ eval/                        # è¯„æµ‹ç»“æžœ
```

---

## 7. å·²éªŒè¯

- [x] Qdrant Docker å¯åŠ¨ + collection åˆ›å»º
- [x] BGE-M3 æ¨¡åž‹åŠ è½½ + dense/sparse ç¼–ç 
- [x] BGE-Reranker-v2-M3 é‡æŽ’åº
- [x] index.py ç´¢å¼•å•æ–‡ä»¶ + çŠ¶æ€æŸ¥è¯¢
- [x] MCP Server hybrid_search + keyword_search
- [x] ä¸­æ–‡è¯­ä¹‰æ£€ç´¢ï¼ˆ"Redis ä¸»ä»Žåˆ‡æ¢åŽåº”ç”¨å¦‚ä½•é‡è¿žï¼Ÿ" â†’ score 4.89ï¼‰
- [x] è‹±æ–‡è¯­ä¹‰æ£€ç´¢ï¼ˆ"How to fix pod CrashLoopBackOff?" â†’ score 4.11ï¼‰
- [x] è·¨è¯­è¨€æ£€ç´¢ï¼ˆä¸­æ–‡ query â†’ è‹±æ–‡æ–‡æ¡£ï¼Œscore 0.37ï¼‰
- [x] å…³é”®è¯æ£€ç´¢ï¼ˆ"JWT" â†’ API è®¤è¯æ–‡æ¡£ï¼‰
- [x] /search skill ç«¯åˆ°ç«¯ï¼ˆGrep å¿«é€Ÿæ£€ç´¢ â†’ è¯»å–æ–‡æ¡£ â†’ å›žç­”ï¼‰

---

## 8. è¿›å±•

### Phase 1: æ ¸å¿ƒåŠŸèƒ½ âœ…
- [x] index.py å¢žé‡ç´¢å¼•ï¼ˆåŸºäºŽ git diff + doc_hashï¼‰
- [x] index.py å…¨é‡é‡å»ºï¼ˆ--fullï¼‰
- [x] è¯­ä¹‰åˆ†å—ï¼šHeading-based åˆ‡åˆ† + section_path ä¿ç•™
- [x] Agentic Routerï¼šAgent è‡ªä¸»è·¯ç”±ï¼Œéžä¸²è¡Œ fallback
- [x] é˜²å¹»è§‰çº¦æŸï¼šå¿…é¡»åŸºäºŽæ£€ç´¢ç»“æžœå›žç­”
- [x] delete_by_source_repoï¼šæŒ‰ä»“åº“æ‰¹é‡åˆ é™¤ç´¢å¼•

### Phase 2: è¯„æµ‹ä½“ç³» âœ…
- [x] 64 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼ˆLocal 17 + Qdrant 41 + Notfound 6ï¼‰
- [x] Gate é—¨ç¦ + è´¨é‡æ£€æŸ¥ä¸¤é˜¶æ®µè¯„ä¼°
- [x] extract_contexts ä»Ž Agent SDK messages_log æå–ç»“æž„åŒ– contexts
- [x] USE_MCP=0: 23/64 (35.9%), USE_MCP=1: 60/64 (93.8%)

### Phase 3: ä»“åº“å¯¼å…¥ ðŸ”§ (å½“å‰)
- [x] /ingest-repo skill å®šä¹‰
- [x] æž¶æž„è§„èŒƒï¼ˆSkill vs Python vs Subagentï¼‰
- [ ] å®žé™…è¿è¡ŒéªŒè¯ /ingest-repo
- [ ] æ ¼å¼æ‰©å±•ï¼šPDF (MinerU) / DOCX (Pandoc)

### Phase 4: ç”Ÿæ€æ‰©å±•
- [ ] ç®—åŠ›è§£è€¦ï¼šMCP HTTP transport æ”¯æŒè¿œç¨‹ GPU æœåŠ¡å™¨
- [ ] CI é›†æˆæ£€ç´¢å›žå½’
- [ ] ç¤ºä¾‹ä»“åº“ï¼škb-example-sre-runbook

---

## 9. ä¾èµ–

```
# æ ¸å¿ƒï¼ˆå¿…é¡»ï¼‰
FlagEmbedding>=1.2.0
qdrant-client>=1.9.0
mcp[cli]>=1.0.0
python-frontmatter>=1.1.0
torch>=2.0.0
numpy>=1.24.0
transformers>=4.38.0,<5.0.0

# é¢„å¤„ç†ï¼ˆæŒ‰éœ€å®‰è£…ï¼‰
# magic-pdf          # MinerUï¼ˆä¸­æ–‡ PDFï¼‰
# docling            # Doclingï¼ˆé€šç”¨æ–‡æ¡£ï¼‰
# marker-pdf         # Markerï¼ˆé«˜ç²¾åº¦ PDFï¼‰
```
