name: KB Update

on:
  workflow_dispatch:
    inputs:
      kb_name:
        description: "KB repo name (e.g. kb-redis-docs)"
        required: true
        default: "kb-redis-docs"
        type: choice
        options:
          - kb-redis-docs
      source_repo:
        description: "Source docs Git repo URL"
        required: true
        default: "https://github.com/redis/docs.git"
      source_subdir:
        description: "Subdirectory within source repo to index (empty = root)"
        required: false
        default: ""
      skip_preprocess:
        description: "Skip LLM preprocessing"
        required: false
        default: true
        type: boolean

jobs:
  update-kb:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    services:
      qdrant:
        image: qdrant/qdrant:latest
        ports: ["6333:6333"]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true
          token: ${{ secrets.KB_PUSH_TOKEN || github.token }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: scripts/requirements.txt

      - name: Cache HuggingFace models
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface/hub
          key: hf-bge-m3-v1

      - name: Install dependencies
        run: pip install -r scripts/requirements.txt

      # Clone source docs
      - name: Clone source repo
        run: |
          git clone --depth 1 ${{ inputs.source_repo }} /tmp/source-docs
          if [ -n "${{ inputs.source_subdir }}" ]; then
            SOURCE_PATH="/tmp/source-docs/${{ inputs.source_subdir }}"
          else
            SOURCE_PATH="/tmp/source-docs"
          fi
          echo "SOURCE_PATH=$SOURCE_PATH" >> $GITHUB_ENV

          # Count docs
          DOC_COUNT=$(find "$SOURCE_PATH" -name "*.md" | wc -l)
          echo "Found $DOC_COUNT markdown files in source"

      # Rsync to KB repo
      - name: Sync docs to KB repo
        run: |
          KB_REPO="kb/${{ inputs.kb_name }}"
          KB_NAME="${{ inputs.kb_name }}"
          DOC_SUBDIR="${KB_NAME#kb-}"

          mkdir -p "$KB_REPO/docs/$DOC_SUBDIR"
          rsync -a --delete "$SOURCE_PATH/" "$KB_REPO/docs/$DOC_SUBDIR/"

          DOC_COUNT=$(find "$KB_REPO/docs/$DOC_SUBDIR" -name "*.md" | wc -l)
          echo "Synced $DOC_COUNT markdown files to $KB_REPO/docs/$DOC_SUBDIR/"

          echo "DOC_SUBDIR=$DOC_SUBDIR" >> $GITHUB_ENV
          echo "KB_REPO=$KB_REPO" >> $GITHUB_ENV
          echo "DOC_COUNT=$DOC_COUNT" >> $GITHUB_ENV

      # Index
      - name: Build vector index
        run: |
          python scripts/index.py --full "$KB_REPO/docs/$DOC_SUBDIR"
        env:
          QDRANT_URL: http://localhost:6333

      - name: Verify index
        run: python scripts/index.py --status
        env:
          QDRANT_URL: http://localhost:6333

      # Export snapshot
      - name: Export Qdrant snapshot
        run: |
          mkdir -p "$KB_REPO/snapshots"
          python scripts/index.py --snapshot-export "$KB_REPO/snapshots/knowledge-base.snapshot"
          SNAP_SIZE=$(du -h "$KB_REPO/snapshots/knowledge-base.snapshot" | cut -f1)
          echo "Snapshot exported: $SNAP_SIZE"
          echo "SNAP_SIZE=$SNAP_SIZE" >> $GITHUB_ENV
        env:
          QDRANT_URL: http://localhost:6333

      # Commit and push KB repo
      - name: Commit and push KB repo
        run: |
          cd "$KB_REPO"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update $DOC_SUBDIR docs + snapshot ($(date +%Y-%m-%d))

          $DOC_COUNT markdown files, snapshot $SNAP_SIZE

          Source: ${{ inputs.source_repo }}
          Triggered by: workflow_dispatch"
            git push
            echo "Pushed to KB repo"
          fi

      # Update submodule ref in main repo
      - name: Update submodule reference
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$KB_REPO"
          if git diff --cached --quiet; then
            echo "Submodule ref unchanged"
          else
            git commit -m "chore: update ${{ inputs.kb_name }} submodule ref"
            git push
            echo "Updated submodule ref in main repo"
          fi
